<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cosmic Race</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  background:#020617;
  color:#e2e8f0;
  font-family:monospace;
}

.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}

.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:24px;
  padding:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
  text-align:center;
}

.btn{
  width:100%;
  padding:16px;
  border-radius:16px;
  border:none;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}

.join{background:#06b6d4;color:white;}
.start{background:#10b981;color:white;}
.reset{background:white;color:black;}
.push{
  width:130px;height:130px;border-radius:50%;
  background:linear-gradient(135deg,#06b6d4,#1d4ed8);
  color:white;font-size:26px;font-weight:bold;
  display:flex;align-items:center;justify-content:center;
  margin:auto;border:4px solid rgba(255,255,255,.2);
}

.player{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:16px;
  padding:12px;
  margin:8px 0;
}

.bar{
  height:4px;
  background:#334155;
  border-radius:4px;
  overflow:hidden;
}

.fill{
  height:100%;
  background:#06b6d4;
}
</style>
</head>

<body>
<div class="container">

<h1>COSMIC RACE</h1>
<p id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</p>

<div class="card" id="main"></div>

<h3>–¢–µ–ª–µ–º–µ—Ç—Ä–∏—è</h3>
<div id="players"></div>

</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyCBb34F6rvslXnwv9HTddwPltllNMJjJMA",
  authDomain:"raketa-de669.firebaseapp.com",
  projectId:"raketa-de669",
  storageBucket:"raketa-de669.firebasestorage.app",
  messagingSenderId:"993322074392",
  appId:"1:993322074392:web:f6768a9065cce493ee1e6d"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const DOC="artifacts/cosmic-race-v1/public/data/cosmic_race/race_state";

let user=null;
let race=null;

auth.signInAnonymously();

auth.onAuthStateChanged(u=>{
  user=u;
  listen();
});

function listen(){
  db.doc(DOC).onSnapshot(s=>{
    if(!s.exists){
      db.doc(DOC).set({
        raceStatus:"LOBBY",
        players:{},
        winnerId:null,
        distanceToWin:100,
        lastUpdate:Date.now()
      });
      return;
    }
    race=s.data();
    draw();
  });
}

function draw(){
  status.innerText="–°—Ç–∞—Ç—É—Å: "+race.raceStatus;

  const inRace=race.players?.[user.uid];
  let html="";

  if(race.raceStatus==="LOBBY"){
    if(!inRace)
      html+=`<button class="btn join" onclick="join()">–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø</button>`;
    else
      html+=`<button class="btn start" onclick="start()">–ü–û–ß–ê–¢–ò –ì–û–ù–ö–£</button>`;
  }

  if(race.raceStatus==="RACING"){
    if(inRace)
      html+=`<div class="push" onclick="push()">PUSH</div>`;
    else
      html+=`<p>–í–∏ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á‚Ä¶</p>`;
  }

  if(race.raceStatus==="FINISHED"){
    const name=race.players?.[race.winnerId]?.name || "UNKNOWN";
    html+=`<h2>${name}</h2>
           <button class="btn reset" onclick="reset()">–ù–û–í–ê –ì–û–ù–ö–ê</button>`;
  }

  main.innerHTML=html;

  players.innerHTML="";
  Object.entries(race.players||{})
    .sort((a,b)=>b[1].position-a[1].position)
    .forEach(([id,p],i)=>{
      players.innerHTML+=`
      <div class="player">
        #${i+1} ${p.shipIcon} ${p.name} ${id===user.uid?"‚Ä¢ –í–ò":""}
        <div class="bar"><div class="fill" style="width:${p.position}%"></div></div>
      </div>`;
    });
}

async function join(){
  const icons=["üöÄ","üõ∞Ô∏è","üõ∏","üåå","üå†","‚òÑÔ∏è"];
  const c=Object.keys(race.players||{}).length;

  await db.doc(DOC).update({
    [`players.${user.uid}`]:{
      name:"–ü—ñ–ª–æ—Ç "+user.uid.slice(0,4),
      position:0,
      shipIcon:icons[c%icons.length]
    },
    lastUpdate:Date.now()
  });
}

async function start(){
  await db.doc(DOC).update({raceStatus:"RACING",lastUpdate:Date.now()});
}

async function push(){
  const p=race.players[user.uid];
  if(!p)return;

  let pos=p.position+Math.random()*8+2;

  if(pos>=100){
    await db.doc(DOC).update({
      [`players.${user.uid}.position`]:100,
      raceStatus:"FINISHED",
      winnerId:user.uid,
      lastUpdate:Date.now()
    });
  }else{
    await db.doc(DOC).update({
      [`players.${user.uid}.position`]:pos,
      lastUpdate:Date.now()
    });
  }
}

async function reset(){
  await db.doc(DOC).set({
    raceStatus:"LOBBY",
    players:{},
    winnerId:null,
    distanceToWin:100,
    lastUpdate:Date.now()
  });
}
</script>
</body>
</html>
