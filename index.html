<!DOCTYPE html>
<html lang="ru">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Cosmic Race</title>
  
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
    <style>
          body {
                  background: black;
                  color: #00ffcc;
                  font-family: monospace;
                  text-align: center;
                  padding: 20px;
          }

          button {
                  padding: 10px 20px;
                  margin: 10px;
                  font-size: 16px;
                  background: #001f1f;
                  color: #00ffcc;
                  border: 1px solid #00ffcc;
                  cursor: pointer;
          }

          .player {
                  margin: 5px 0;
          }
        </style>
  </head>
  <body>

    <h1>üöÄ COSMIC RACE</h1>
  <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  
  <div id="controls" style="display:none;">
    <button onclick="joinRace()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    <button onclick="startRace()">–°—Ç–∞—Ä—Ç</button>
    <button onclick="push()">PUSH</button>
    <button onclick="resetGame()">–°–±—Ä–æ—Å</button>
  </div>
  
  <h2>–¢–µ–ª–µ–º–µ—Ç—Ä–∏—è</h2>
  <div id="players"></div>
  
  <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCBb34F6rvslXnwv9HTddwPltllNMJjJMA",
        authDomain: "raketa-de669.firebaseapp.com",
        projectId: "raketa-de669",
        storageBucket: "raketa-de669.firebasestorage.app",
        messagingSenderId: "993322074392",
        appId: "1:993322074392:web:f6768a9065cce493ee1e6d"
    };

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const RACE_DOC = "cosmic_race/race_state";

    let user = null;
    let raceState = null;

    auth.signInAnonymously();

    auth.onAuthStateChanged(u => {
        user = u;
        document.getElementById("controls").style.display = "block";
        listenRace();
    });

    function listenRace() {
        db.doc(RACE_DOC).onSnapshot(doc => {
              if (!doc.exists) {
                      db.doc(RACE_DOC).set({
                                raceStatus: "LOBBY",
                                players: {},
                                winnerId: null,
                                distanceToWin: 100,
                                lastUpdate: Date.now()
                      });
                      return;
              }

              raceState = doc.data();
              render();
        });
    }

    function render() {
        document.getElementById("status").innerText =
              "–°—Ç–∞—Ç—É—Å: " + raceState.raceStatus;

        const list = document.getElementById("players");
        list.innerHTML = "";

        const players = Object.entries(raceState.players || {})
          .sort((a,b)=>b[1].position-a[1].position);

        players.forEach(([id,p],i)=>{
              const el = document.createElement("div");
              el.className="player";
              el.innerText =
                      `#${i+1} ${p.shipIcon} ${p.name} ‚Äî ${Math.round(p.position)}%`
                + (id===user.uid ? " (—Ç—ã)" : "");
              list.appendChild(el);
        });
    }

    async function joinRace() {
        if (!raceState || raceState.raceStatus !== "LOBBY") return;

        const icons = ["üöÄ","üõ∞Ô∏è","üõ∏","üåå","üå†","‚òÑÔ∏è"];
        const count = Object.keys(raceState.players || {}).length;

        await db.doc(RACE_DOC).update({
              [`players.${user.uid}`]: {
                      name: "–ü–∏–ª–æ—Ç " + user.uid.substring(0,4),
                      position: 0,
                      shipIcon: icons[count % icons.length]
              },
              lastUpdate: Date.now()
        });
    }

    async function startRace() {
        await db.doc(RACE_DOC).update({
              raceStatus: "RACING",
              lastUpdate: Date.now()
        });
    }

    async function push() {
        if (!raceState || raceState.raceStatus !== "RACING") return;

        const player = raceState.players[user.uid];
        if (!player) return;

        let newPos = player.position + Math.random()*8 + 2;

        if (newPos >= 100) {
              await db.doc(RACE_DOC).update({
                      [`players.${user.uid}.position`]: 100,
                      raceStatus: "FINISHED",
                      winnerId: user.uid,
                      lastUpdate: Date.now()
              });
        } else {
              await db.doc(RACE_DOC).update({
                      [`players.${user.uid}.position`]: newPos,
                      lastUpdate: Date.now()
              });
        }
    }

    async function resetGame() {
        await db.doc(RACE_DOC).set({
              raceStatus: "LOBBY",
              players: {},
              winnerId: null,
              distanceToWin: 100,
              lastUpdate: Date.now()
        });
    }
  </script>

  </body>
</html>
