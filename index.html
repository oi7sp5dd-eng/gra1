<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cosmic Race</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body { margin:0; font-family: Inter, sans-serif; background:#000; }

/* üåå SPACE BACKGROUND */
.space-bg {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: -1;
overflow: hidden;
background: radial-gradient(ellipse at bottom, #0b1020 0%, #030712 60%, #000 100%);
}

.stars {
position: absolute;
width: 200%;
height: 200%;
background-image:
radial-gradient(2px 2px at 20% 30%, white, transparent),
radial-gradient(1.5px 1.5px at 40% 70%, white, transparent),
radial-gradient(1.5px 1.5px at 90% 40%, white, transparent),
radial-gradient(2px 2px at 70% 80%, white, transparent),
radial-gradient(1.5px 1.5px at 10% 90%, white, transparent);
background-repeat: repeat;
animation: moveStars 120s linear infinite;
opacity: 0.6;
}

@keyframes moveStars {
from { transform: translateY(0); }
to { transform: translateY(-500px); }
}

.nebula {
position: absolute;
width: 150%;
height: 150%;
background:
radial-gradient(circle at 30% 40%, rgba(56,189,248,0.15), transparent 40%),
radial-gradient(circle at 70% 60%, rgba(139,92,246,0.15), transparent 40%);
animation: drift 60s ease-in-out infinite alternate;
}

@keyframes drift {
from { transform: translateX(-50px); }
to { transform: translateX(50px); }
}

.progress-glow { box-shadow:0 0 15px rgba(6,182,212,.4); }
.btn-active:active { transform:scale(.95); }
</style>
</head>
<body class="text-slate-200">

<div class="space-bg">
  <div class="stars"></div>
  <div class="nebula"></div>
</div>

<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction };
</script>

<script type="text/babel">

const {
initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction
} = window.firebaseModules;

const firebaseConfig = {
apiKey: "AIzaSyCBb34F6rvslXnwv9HTddwPltllNMJjJMA",
authDomain: "raketa-de669.firebaseapp.com",
projectId: "raketa-de669",
storageBucket: "raketa-de669.firebasestorage.app",
messagingSenderId: "993322074392",
appId: "1:993322074392:web:f6768a9065cce493ee1e6d"
};

const appId = firebaseConfig.projectId;
const RACE_DOC_PATH = `/artifacts/${appId}/public/data/cosmic_race/race_state`;

const App = () => {

const [db,setDb] = React.useState(null);
const [user,setUser] = React.useState(null);
const [race,setRace] = React.useState(null);
const [loading,setLoading] = React.useState(true);

React.useEffect(()=>{
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const firestore = getFirestore(app);
setDb(firestore);
signInAnonymously(auth);
return onAuthStateChanged(auth,(u)=>{
setUser(u);
if(u) setLoading(false);
});
},[]);

React.useEffect(()=>{
if(!db || !user) return;
const raceRef = doc(db,RACE_DOC_PATH);
const unsub = onSnapshot(raceRef,(snap)=>{
if(snap.exists()){
setRace(snap.data());
}
});
return ()=>unsub();
},[db,user]);

const join = async ()=>{
if(!db || !user) return;
const raceRef = doc(db,RACE_DOC_PATH);
await runTransaction(db, async (tx)=>{
const snap = await tx.get(raceRef);
if(!snap.exists()){
tx.set(raceRef,{
raceStatus:"LOBBY",
players:{},
winnerId:null,
lastUpdate:Date.now()
});
return;
}
const data = snap.data();
if(data.raceStatus === "FINISHED") return;
if(data.players?.[user.uid]) return;
const icons=["üöÄ","üõ∏","üõ∞Ô∏è","üå†","‚òÑÔ∏è"];
const names=["MIEL","ZETA","ORION","NOVA","VEGA"];
const count = Object.keys(data.players || {}).length;
tx.update(raceRef,{
[`players.${user.uid}`]:{
name:`–ü–Ü–õ–û–¢ ${names[count % names.length]}`,
position:0,
shipIcon:icons[count % icons.length]
},
lastUpdate:Date.now()
});
});
};

const start = async ()=>{
await updateDoc(doc(db,RACE_DOC_PATH),{
raceStatus:"RACING",
lastUpdate:Date.now()
});
};

const move = async ()=>{
if(race?.raceStatus !== "RACING") return;
if(!race.players?.[user.uid]) return;
const raceRef = doc(db,RACE_DOC_PATH);
const current = race.players[user.uid].position || 0;
const newPos = current + Math.random()*5 + 3;
if(newPos >= 100){
await updateDoc(raceRef,{
[`players.${user.uid}.position`]:100,
raceStatus:"FINISHED",
winnerId:user.uid,
lastUpdate:Date.now()
});
}else{
await updateDoc(raceRef,{
[`players.${user.uid}.position`]:newPos,
lastUpdate:Date.now()
});
}
};

const reset = async ()=>{
await setDoc(doc(db,RACE_DOC_PATH),{
raceStatus:"LOBBY",
players:{},
winnerId:null,
lastUpdate:Date.now()
});
};

if(loading) return <div className="flex justify-center items-center min-h-screen">Connecting...</div>;

const isParticipant = race?.players?.[user.uid];

return(
<div className="max-w-md mx-auto p-6 space-y-6 min-h-screen flex flex-col">

<header className="text-center pt-4">
<h1 className="text-4xl font-black italic">COSMIC RACE</h1>
</header>

<main className="bg-slate-900/60 p-8 rounded-3xl text-center space-y-6 backdrop-blur-md">

{(race?.raceStatus === "LOBBY" || race?.raceStatus === "RACING") && (
<>
{!isParticipant && (
<button onClick={join} className="btn-active w-full bg-cyan-600 py-4 rounded-xl font-bold uppercase">
–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
</button>
)}

{race?.raceStatus === "LOBBY" && isParticipant && (
<button onClick={start} className="btn-active w-full bg-emerald-600 py-4 rounded-xl font-bold uppercase">
–ü–æ—á–∞—Ç–∏ –≥–æ–Ω–∫—É
</button>
)}

{race?.raceStatus === "RACING" && isParticipant && (
<button onClick={move} className="btn-active w-40 h-40 mx-auto bg-cyan-500 rounded-full text-3xl font-black">
PUSH
</button>
)}
</>
)}

{race?.raceStatus === "FINISHED" && (
<>
<h2 className="text-xl font-bold text-yellow-400">
üèÜ –ü–µ—Ä–µ–º—ñ–≥ {race.players[race.winnerId]?.name}
</h2>
<button onClick={reset} className="w-full bg-slate-700 py-3 rounded-xl font-bold">
–ù–æ–≤–∞ –≥—Ä–∞
</button>
</>
)}

</main>

<section className="space-y-3">
{Object.entries(race?.players || {})
.sort((a,b)=>b[1].position - a[1].position)
.map(([id,p])=>(
<div key={id} className="p-4 bg-slate-800/70 rounded-xl backdrop-blur-md">
<div className="flex justify-between text-sm font-bold">
<span>{p.shipIcon} {p.name}</span>
<span>{Math.round(p.position)}%</span>
</div>
<div className="h-2 bg-slate-700 rounded-full mt-2 overflow-hidden">
<div className="h-full bg-cyan-500 progress-glow"
style={{width:`${p.position}%`}}></div>
</div>
</div>
))}
</section>

</div>
);
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);

</script>
</body>
</html>
