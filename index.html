<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º—ñ—á–Ω—ñ –ü–µ—Ä–µ–≥–æ–Ω–∏ - Multiplayer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –¥–ª—è –µ—Å—Ç–µ—Ç–∏–∫–∏ */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root">
        <!-- –°—é–¥–∏ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ React-–¥–æ–¥–∞—Ç–æ–∫ -->
    </div>

    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫: React, ReactDOM —Ç–∞ Babel (–¥–ª—è –æ–±—Ä–æ–±–∫–∏ JSX) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤ Firebase –∑ CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –†–æ–±–∏–º–æ Firebase —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction
        };
    </script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–¥ –≥—Ä–∏ (JSX) -->
    <script type="text/babel">
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ, –Ω–∞–¥–∞–Ω—ñ Canvas (—è–∫—â–æ –≤–æ–Ω–∏ —î)
        let firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
        let initialAuthToken = window.__initial_auth_token || null;
        let appId = window.__app_id || 'default-app-id';

        // ====================================================================================
        // !!! –ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û: –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø FIREBASE –î–õ–Ø –ó–û–í–ù–Ü–®–ù–¨–û–ì–û –•–û–°–¢–ò–ù–ì–£ !!!
        // –Ø–∫—â–æ –≤–∏ –∑–∞–ø—É—Å–∫–∞—î—Ç–µ —Ü–µ–π –∫–æ–¥ –Ω–∞ GitHub Pages, Google Sites –∞–±–æ –ª–æ–∫–∞–ª—å–Ω–æ,
        // –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ Canvas –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ. –í–°–¢–ê–í–¢–ï –°–í–û–Æ –†–ï–ê–õ–¨–ù–£ –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Æ Firebase —Ç—É—Ç:
        // ====================================================================================
        if (!firebaseConfig) {
            firebaseConfig = {
                // –í–°–¢–ê–í–õ–ï–ù–ê –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê
                apiKey: "AIzaSyCBb34F6rvslXnwv9HTddwPltllNMJjJMA",
                authDomain: "raketa-de669.firebaseapp.com",
                projectId: "raketa-de669",
                storageBucket: "raketa-de669.firebasestorage.app",
                messagingSenderId: "993322074392",
                appId: "1:993322074392:web:f6768a9065cce493ee1e6d",
            };
            
            // –Ø–∫—â–æ ID –ø—Ä–æ–≥—Ä–∞–º–∏ –Ω–µ –Ω–∞–¥–∞–Ω–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ–º (—Ç–æ–±—Ç–æ –∑–∞–ø—É—â–µ–Ω–æ –∑–æ–≤–Ω—ñ),
            // –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Project ID –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–æ–≥–æ —à–ª—è—Ö—É –¥–æ –¥–∞–Ω–∏—Ö.
            if (appId === 'default-app-id' && firebaseConfig.projectId) {
                appId = firebaseConfig.projectId; 
            }
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
            if (!firebaseConfig.apiKey) {
                firebaseConfig.apiKey = null; 
            }
        }
        // ====================================================================================

        // –®–ª—è—Ö –¥–æ –∑–∞–≥–∞–ª—å–Ω–æ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å—Ç–∞–Ω—É –≥–æ–Ω–∫–∏ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π appId)
        const RACE_DOC_PATH = `/artifacts/${appId}/public/data/cosmic_race/race_state`;
        const DISTANCE_TO_WIN = 100; // –î–∏—Å—Ç–∞–Ω—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–º–æ–≥–∏

        const {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction
        } = window.firebaseModules;

        const CosmicRace = () => {
            const [db, setDb] = React.useState(null);
            const [auth, setAuth] = React.useState(null);
            const [userId, setUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            const [raceState, setRaceState] = React.useState(null);
            const [error, setError] = React.useState('');
            // –î–æ–¥–∞–Ω–æ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
            const [isMakingProgress, setIsMakingProgress] = React.useState(false); 

            // --- 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase —Ç–∞ –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è ---
            React.useEffect(() => {
                // –ï—Å–ª–∏ –Ω–µ—Ç API –∫–ª—é—á–∞ (—Ç.–µ. config –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω)
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    setError("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ü–æ–º–∏–ª–∫–∞: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase –Ω–µ –Ω–∞–¥–∞–Ω–∞. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤—Ç–µ –≤–∞—à –æ–±'—î–∫—Ç –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó Firebase —É –≤–∏–¥—ñ–ª–µ–Ω–∏–π –±–ª–æ–∫ –∫–æ–¥—É –¥–ª—è —Ä–æ–±–æ—Ç–∏.");
                    setIsAuthReady(true); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                    return;
                }
                
                try {
                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const authInstance = getAuth(app);

                    setDb(firestore);
                    setAuth(authInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                        } else {
                            // –ê–Ω–æ–Ω—ñ–º–Ω–∏–π –≤—Ö—ñ–¥ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ CustomToken, —è–∫—â–æ –≤—ñ–Ω —î, —ñ–Ω–∞–∫—à–µ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –∞–Ω–æ–Ω—ñ–º–Ω–∏–π –≤—Ö—ñ–¥)
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(authInstance, initialAuthToken);
                                } else {
                                    // –¶–µ —Å—Ä–∞–±–æ—Ç–∞—î –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–º—É —Ö–æ—Å—Ç–∏–Ω–≥—É
                                    await signInAnonymously(authInstance);
                                }
                            } catch (e) {
                                console.error("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:", e);
                                setError(`–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó: ${e.message}. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ Auth —Ç–∞ Firestore –≤–∫–ª—é—á–µ–Ω—ñ —É –≤–∞—à–æ–º—É –ø—Ä–æ–µ–∫—Ç—ñ Firebase.`);
                                setIsAuthReady(true);
                            }
                        }
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", e);
                    setError(`–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase: ${e.message}`);
                }
            }, []);

            // --- 2. –°–ª—É—Ö–∞—á —Å—Ç–∞–Ω—É –ì–æ–Ω–∫–∏ (onSnapshot) ---
            React.useEffect(() => {
                // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∑–∞–ø–∏—Ç–∞–º –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω–æ—Å—Ç—ñ DB
                if (!isAuthReady || !db || !userId || error) return;

                const raceRef = doc(db, RACE_DOC_PATH);

                const unsubscribe = onSnapshot(raceRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setRaceState(docSnap.data());
                    } else {
                        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å—Ç–∞–Ω –≥–æ–Ω–∫–∏, —è–∫—â–æ –≤—ñ–Ω –Ω–µ —ñ—Å–Ω—É—î
                        const initialRaceState = {
                            raceStatus: 'LOBBY', // LOBBY, RACING, FINISHED
                            distanceToWin: DISTANCE_TO_WIN,
                            players: {},
                            winnerId: null,
                        };
                        setRaceState(initialRaceState);
                        
                        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≥–æ–Ω–∫–∏
                        setDoc(raceRef, initialRaceState).catch(e => {
                            console.error("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≥–æ–Ω–∫–∏:", e);
                        }); 
                    }
                }, (e) => {
                    // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ Firestore
                    console.error("Firestore –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö:", e);
                    if (e.code === 'permission-denied') {
                        // –≠—Ç–∞ –æ—à–∏–±–∫–∞ —á–∞—Å—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                        setError("–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ü—Ä–∞–≤–∏–ª–∞ –ë–µ–∑–ø–µ–∫–∏ Firestore! (PERMISSION_DENIED).");
                        console.error("CRITICAL ERROR: Access denied. Check Firestore Security Rules.");
                    } else {
                        setError(`–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Firestore: ${e.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`);
                    }
                });

                return () => unsubscribe();
            }, [isAuthReady, db, userId, error]);

            // --- 3. –§—É–Ω–∫—Ü—ñ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –≥—Ä–æ—é ---

            const resetRace = React.useCallback(async () => {
                if (!db) return;
                const raceRef = doc(db, RACE_DOC_PATH);

                try {
                    await setDoc(raceRef, {
                        raceStatus: 'LOBBY',
                        distanceToWin: DISTANCE_TO_WIN,
                        players: {},
                        winnerId: null,
                    });
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∫–∏–¥–∞–Ω–Ω—è –≥–æ–Ω–∫–∏:", e);
                    setError("–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–∏–Ω—É—Ç–∏ –≥–æ–Ω–∫—É.");
                }
            }, [db]);

            const joinRace = React.useCallback(async () => {
                if (!db || !userId || !raceState || raceState.raceStatus !== 'LOBBY') return;
                
                const raceRef = doc(db, RACE_DOC_PATH);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(raceRef);
                        if (!docSnap.exists()) {
                            throw new Error("–î–æ–∫—É–º–µ–Ω—Ç –≥–æ–Ω–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
                        }
                        
                        const currentData = docSnap.data();
                        
                        if (currentData.players[userId]) return;

                        const newPlayers = {
                            ...currentData.players,
                            [userId]: {
                                name: `–ü—ñ–ª–æ—Ç ${userId.substring(0, 4)}`,
                                position: 0,
                                lastUpdate: Date.now(),
                                shipIcon: getShipIcon(Object.keys(currentData.players).length),
                            }
                        };
                        
                        transaction.update(raceRef, { players: newPlayers });
                    });
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –≥–æ–Ω–∫–∏:", e);
                    setError(`–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è: ${e.message}`);
                }
            }, [db, userId, raceState]);

            const makeProgress = React.useCallback(async () => {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É, –≤–∫–ª—é—á–∞—é—á–∏ isMakingProgress
                if (!db || !userId || !raceState || raceState.raceStatus !== 'RACING' || isMakingProgress) return;
                if (!raceState.players[userId]) {
                    setError("–í–∏ –Ω–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –≤ –≥–æ–Ω—Ü—ñ.");
                    return;
                }

                setIsMakingProgress(true); // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É
                
                const raceRef = doc(db, RACE_DOC_PATH);
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const docSnap = await transaction.get(raceRef);
                        if (!docSnap.exists()) return;

                        const currentData = docSnap.data();
                        const player = currentData.players[userId];
                        
                        if (!player) return;
                        
                        // –î–æ–¥–∞—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
                        let newPosition = Math.min(DISTANCE_TO_WIN, player.position + Math.random() * 5 + 1);
                        
                        const newPlayers = { ...currentData.players };
                        newPlayers[userId] = { ...player, position: newPosition };

                        const updatePayload = { players: newPlayers };
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–º–æ–≥–∏
                        if (newPosition >= DISTANCE_TO_WIN && currentData.raceStatus === 'RACING') {
                            updatePayload.raceStatus = 'FINISHED';
                            updatePayload.winnerId = userId;
                        }
                        
                        transaction.update(raceRef, updatePayload);
                    });
                } catch (e) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—É:", e);
                } finally {
                    // –ó–Ω—ñ–º–∞—î–º–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –Ω–µ–≤–µ–ª–∏–∫—É –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
                    setTimeout(() => {
                        setIsMakingProgress(false);
                    }, 150); 
                }
            }, [db, userId, raceState, isMakingProgress]);
            
            // --- 4. –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è ---

            const sortedPlayers = React.useMemo(() => {
                if (!raceState || !raceState.players) return [];
                return Object.keys(raceState.players)
                    .map(key => ({ ...raceState.players[key], id: key }))
                    .sort((a, b) => b.position - a.position) // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –ø–æ–∑–∏—Ü—ñ—î—é (–≤—ñ–¥ –±—ñ–ª—å—à–æ–≥–æ –¥–æ –º–µ–Ω—à–æ–≥–æ)
                    .map((player, index) => ({
                        ...player,
                        rank: index + 1,
                    }));
            }, [raceState]);

            const userPlayer = raceState?.players?.[userId];
            const raceStarted = raceState?.raceStatus === 'RACING';

            function getShipIcon(index) {
                const icons = ["üöÄ", "üõ∞Ô∏è", "üõ∏", "üåå", "üå†", "‚òÑÔ∏è", "ü™ê", "‚≠ê"];
                return icons[index % icons.length];
            }

            const RaceProgressBar = ({ position, max }) => {
                const percentage = Math.min(100, (position / max) * 100);
                return (
                    <div className="w-full bg-gray-700 rounded-full h-3.5 relative overflow-hidden shadow-inner">
                        <div
                            className="h-3.5 rounded-full bg-gradient-to-r from-purple-400 to-pink-500 transition-all duration-300 ease-out"
                            style={{ width: `${percentage}%` }}
                        ></div>
                        <span className="absolute inset-0 text-xs font-bold text-white leading-3.5 flex items-center justify-center" style={{ textShadow: '0 0 2px black' }}>
                            {Math.round(position)} / {max}
                        </span>
                    </div>
                );
            };


            // --- 5. –†–µ–Ω–¥–µ—Ä –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ---
            
            if (error) {
                return <div className="p-8 text-center text-red-500 bg-gray-900 min-h-screen flex flex-col items-center justify-center">
                    <h2 className="text-3xl font-bold mb-4">–ö—Ä–∏—Ç–∏—á–Ω–∞ –ü–æ–º–∏–ª–∫–∞:</h2>
                    <p className="max-w-md">{error}</p>
                    {error.includes("–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase –Ω–µ –Ω–∞–¥–∞–Ω–∞") && (
                        <p className="mt-4 text-yellow-400">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±–ª–æ–∫ `–ö–†–ò–¢–ò–ß–ù–û –í–ê–ñ–õ–ò–í–û` —É `&lt;script type="text/babel"&gt;` —ñ –≤—Å—Ç–∞–≤—Ç–µ —Å–≤–æ—ó –∫–ª—é—á—ñ!</p>
                    )}
                </div>;
            }

            if (!isAuthReady || !raceState) {
                return <div className="p-8 text-center text-purple-400 min-h-screen flex items-center justify-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è... –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É –∑ –∫–æ—Å–º–æ—Å–æ–º...</div>;
            }

            return (
                <div className="min-h-screen bg-gray-900 text-white p-4 sm:p-8 flex flex-col items-center">
                    
                    <header className="text-center mb-8">
                        <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-600">
                            –ö–æ—Å–º—ñ—á–Ω—ñ –ü–µ—Ä–µ–≥–æ–Ω–∏
                        </h1>
                        <p className="text-gray-400 mt-2 text-lg">–ë–∞–≥–∞—Ç–æ–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∞ –≥–æ–Ω–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</p>
                    </header>

                    <div className="w-full max-w-lg mb-6 p-4 bg-gray-800 rounded-xl shadow-2xl border border-purple-500/30">
                        <p className="text-sm text-gray-400">–í–∞—à ID (–¥–ª—è –∑–º–∞–≥–∞–Ω—å): <code className="text-pink-400 break-all">{userId}</code></p>
                        {userPlayer && (
                            <p className="text-lg mt-2 font-bold flex items-center">
                                –í–∞—à –ø—ñ–ª–æ—Ç: <span className="ml-2 text-cyan-400">{userPlayer.shipIcon} {userPlayer.name}</span>
                            </p>
                        )}
                    </div>

                    {/* --- –°—Ç–∞–Ω –ì–æ–Ω–∫–∏ --- */}
                    <div className="w-full max-w-lg mb-8 p-6 bg-gray-800 rounded-xl shadow-xl border border-cyan-500/30">
                        {raceState.raceStatus === 'LOBBY' && (
                            <div className="text-center">
                                <h2 className="text-3xl font-bold text-yellow-400 mb-4">–ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ —Å—Ç–∞—Ä—Ç—É!</h2>
                                <p className="text-gray-300 mb-6">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥–æ–Ω–∫–∏", —â–æ–± —Å—Ç–∞—Ç–∏ –ø—ñ–ª–æ—Ç–æ–º. –ö–æ–ª–∏ –ø—Ä–∏—î–¥–Ω–∞—î—Ç—å—Å—è —Ö–æ—á–∞ –± 1 –≥—Ä–∞–≤–µ—Ü—å, –≥–æ–Ω–∫–∞ —Ä–æ–∑–ø–æ—á–Ω–µ—Ç—å—Å—è.</p>
                                
                                {!userPlayer ? (
                                    <button
                                        onClick={joinRace}
                                        className={`font-bold py-3 px-6 rounded-full transition duration-200 shadow-lg transform hover:scale-105 bg-green-600 hover:bg-green-700 shadow-green-500/50`}
                                    >
                                        –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥–æ–Ω–∫–∏
                                    </button>
                                ) : (
                                    <p className="text-green-400 font-semibold text-xl">–í–∏ –≥–æ—Ç–æ–≤—ñ –¥–æ —Å—Ç–∞—Ä—Ç—É!</p>
                                )}
                            </div>
                        )}

                        {raceState.raceStatus === 'RACING' && (
                            <div className="text-center">
                                <h2 className="text-3xl font-bold text-cyan-400 mb-4">–ì–û–ù–ö–ê –¢–†–ò–í–ê–Ñ!</h2>
                                <p className="text-gray-300 mb-4">–®–≤–∏–¥–∫–æ –Ω–∞—Ç–∏—Å–∫–∞–π—Ç–µ "–ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è", —â–æ–± –æ–±—ñ–≥–Ω–∞—Ç–∏ —Å—É–ø–µ—Ä–Ω–∏–∫—ñ–≤!</p>
                                
                                {userPlayer ? (
                                    <button
                                        onClick={makeProgress}
                                        disabled={isMakingProgress}
                                        className={`
                                            font-bold py-4 px-8 rounded-full transition duration-150 shadow-lg transform hover:scale-105 text-xl
                                            ${isMakingProgress 
                                                ? 'bg-purple-800 opacity-60 cursor-not-allowed' 
                                                : 'bg-purple-600 hover:bg-purple-700 animate-pulse shadow-purple-500/50'}
                                        `}
                                    >
                                        –ü–†–ò–°–ö–û–†–ï–ù–ù–Ø! ‚ö°
                                    </button>
                                ) : (
                                    <p className="text-red-400">–í–∏ –Ω–µ –±–µ—Ä–µ—Ç–µ —É—á–∞—Å—Ç—å —É —Ü—ñ–π –≥–æ–Ω—Ü—ñ.</p>
                                )}
                            </div>
                        )}

                        {raceState.raceStatus === 'FINISHED' && (
                            <div className="text-center">
                                <h2 className="text-4xl font-extrabold text-yellow-500 mb-4">üöÄ –ü–ï–†–ï–ú–û–ì–ê! üèÜ</h2>
                                <p className="text-xl text-gray-300 mb-6">
                                    {raceState.winnerId === userId ? (
                                        <span className="text-green-400">–í–∏ - –ø–µ—Ä–µ–º–æ–∂–µ—Ü—å! –í—ñ—Ç–∞—î–º–æ!</span>
                                    ) : (
                                        <span className="text-orange-400">–ü–µ—Ä–µ–º—ñ–≥ –ø—ñ–ª–æ—Ç {raceState.players[raceState.winnerId]?.name || raceState.winnerId?.substring(0, 4)}!</span>
                                    )}
                                </p>
                                <button
                                    onClick={resetRace}
                                    className={`font-bold py-3 px-6 rounded-full transition duration-200 shadow-lg bg-red-600 hover:bg-red-700`}
                                >
                                    –ù–æ–≤–∞ –≥–æ–Ω–∫–∞
                                </button>
                            </div>
                        )}
                        
                        {/* –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ —É RACING, —è–∫—â–æ —î –≥—Ä–∞–≤—Ü—ñ */}
                        {raceState.raceStatus === 'LOBBY' && userPlayer && Object.keys(raceState.players).length >= 1 && (
                            <button
                                onClick={() => updateDoc(doc(db, RACE_DOC_PATH), { raceStatus: 'RACING' })}
                                className={`w-full mt-4 font-bold py-2 rounded-full transition duration-150 shadow-md hover:shadow-lg bg-yellow-500 hover:bg-yellow-600 text-gray-900`}
                            >
                                –°—Ç–∞—Ä—Ç!
                            </button>
                        )}
                        {raceState.raceStatus === 'LOBBY' && Object.keys(raceState.players).length > 0 && (
                            <p className="text-sm text-center mt-4 text-orange-400 font-semibold">
                                –£ –ª–æ–±—ñ: {Object.keys(raceState.players).length} –ø—ñ–ª–æ—Ç—ñ–≤.
                            </p>
                        )}

                    </div>

                    {/* --- –¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤ (–°—Ç–∞–Ω –≥–æ–Ω–∫–∏) --- */}
                    <div className="w-full max-w-lg">
                        <h3 className="text-2xl font-bold text-center mb-4 text-purple-400 border-b border-purple-500/50 pb-2">–£—á–∞—Å–Ω–∏–∫–∏</h3>
                        <div className="space-y-4">
                            {sortedPlayers.length === 0 ? (
                                <p className="text-center text-gray-500">–ù—ñ—Ö—Ç–æ —â–µ –Ω–µ –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è...</p>
                            ) : (
                                sortedPlayers.map((player, index) => (
                                    <div 
                                        key={player.id}
                                        className={`flex flex-col p-4 rounded-xl shadow-lg transition-all duration-300 ${
                                            player.rank === 1 ? 'bg-yellow-900/50 border-2 border-yellow-500' : 
                                            (player.position === 0 && raceStarted) ? 'bg-gray-700' :
                                            (player.id === userId ? 'bg-purple-900/50 border border-purple-400' : 'bg-gray-800')
                                        }`}
                                    >
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center">
                                                <span className={`text-2xl font-extrabold mr-3 ${player.rank === 1 ? 'text-yellow-400' : 'text-gray-400'}`}>
                                                    #{player.rank}
                                                </span>
                                                <span className="text-3xl mr-3">{player.shipIcon}</span>
                                                <span className="font-semibold text-xl">{player.name}</span>
                                            </div>
                                            <span className="text-xl font-bold text-right text-green-400">
                                                {Math.round(player.position)} –∫–º
                                            </span>
                                        </div>
                                        <div className="mt-2">
                                            <RaceProgressBar position={player.position} max={DISTANCE_TO_WIN} />
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                    
                </div>
            );
        };

        // –ó–∞–ø—É—Å–∫ React-–¥–æ–¥–∞—Ç–∫–∞
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CosmicRace />);

    </script>
</body>
</html>