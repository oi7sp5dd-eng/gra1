<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—Å–º—ñ—á–Ω—ñ –ü–µ—Ä–µ–≥–æ–Ω–∏ - Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #030712; }
        .progress-glow { box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .btn-active:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-slate-200">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction
        };
    </script>
    
    <script type="text/babel">
        const {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, updateDoc, onSnapshot, runTransaction
        } = window.firebaseModules;

        // –ü–†–Ø–ú–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ)
        const myConfig = {
            apiKey: "AIzaSyCBb34F6rvslXnwv9HTddwPltllNMJjJMA",
            authDomain: "raketa-de669.firebaseapp.com",
            projectId: "raketa-de669",
            storageBucket: "raketa-de669.firebasestorage.app",
            messagingSenderId: "993322074392",
            appId: "1:993322074392:web:f6768a9065cce493ee1e6d",
        };

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–±–æ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É, –ª–∏–±–æ –≤–∞—à—É –ø—Ä—è–º—É—é
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : myConfig;
        const appId = window.__app_id || firebaseConfig.projectId;
        const RACE_DOC_PATH = `/artifacts/${appId}/public/data/cosmic_race/race_state`;

        const App = () => {
            const [db, setDb] = React.useState(null);
            const [user, setUser] = React.useState(null);
            const [race, setRace] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const firestore = getFirestore(app);
                    setDb(firestore);

                    const performAuth = async () => {
                        try {
                            if (window.__initial_auth_token) {
                                console.log("–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Custom Token...");
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                console.log("–í—Ö–æ–¥ –∞–Ω–æ–Ω–∏–º–Ω–æ...");
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth Failure:", e);
                            setError(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á–µ–Ω –ª–∏ Anonymous Auth!`);
                            setLoading(false);
                        }
                    };

                    performAuth();
                    return onAuthStateChanged(auth, (u) => {
                        console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ Auth –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:", u?.uid);
                        setUser(u);
                        if (u) setLoading(false);
                    });
                } catch (e) {
                    setError(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}`);
                    setLoading(false);
                }
            }, []);

            React.useEffect(() => {
                if (!db || !user) return;

                console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firestore –ø–æ –ø—É—Ç–∏:", RACE_DOC_PATH);
                const raceRef = doc(db, RACE_DOC_PATH);
                
                const unsub = onSnapshot(raceRef, (snap) => {
                    if (snap.exists()) {
                        console.log("–î–∞–Ω–Ω—ã–µ –≥–æ–Ω–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã");
                        setRace(snap.data());
                    } else {
                        console.log("–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π...");
                        setDoc(raceRef, {
                            raceStatus: 'LOBBY',
                            players: {},
                            winnerId: null,
                            lastUpdate: Date.now()
                        }).catch(e => {
                            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:", e);
                            setError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore!");
                        });
                    }
                }, (err) => {
                    console.error("Snapshot Error:", err);
                    if (err.code === 'permission-denied') {
                        setError("Permission Denied: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∫–ª–∞–¥–∫—É Rules –≤ Firebase!");
                    } else {
                        setError(`–û—à–∏–±–∫–∞ –ë–î: ${err.message}`);
                    }
                });

                return () => unsub();
            }, [db, user]);

            const join = async () => {
                if (!db || !user || race?.raceStatus !== 'LOBBY') return;
                const raceRef = doc(db, RACE_DOC_PATH);
                try {
                    await runTransaction(db, async (tx) => {
                        const snap = await tx.get(raceRef);
                        const data = snap.data();
                        if (data.players[user.uid]) return;
                        
                        const icons = ["üöÄ", "üõ∏", "üõ∞Ô∏è", "üå†", "‚òÑÔ∏è"];
                        tx.update(raceRef, {
                            [`players.${user.uid}`]: {
                                name: `–ü—ñ–ª–æ—Ç ${user.uid.slice(0,4)}`,
                                position: 0,
                                shipIcon: icons[Object.keys(data.players || {}).length % icons.length]
                            },
                            lastUpdate: Date.now()
                        });
                    });
                } catch (e) { console.error("Join error:", e); }
            };

            const start = () => updateDoc(doc(db, RACE_DOC_PATH), { raceStatus: 'RACING', lastUpdate: Date.now() });
            
            const move = async () => {
                if (race?.raceStatus !== 'RACING') return;
                const raceRef = doc(db, RACE_DOC_PATH);
                const currentPos = race.players[user.uid]?.position || 0;
                const newPos = currentPos + Math.random() * 6 + 2;
                
                if (newPos >= 100) {
                    await updateDoc(raceRef, {
                        [`players.${user.uid}.position`]: 100,
                        raceStatus: 'FINISHED',
                        winnerId: user.uid,
                        lastUpdate: Date.now()
                    });
                } else {
                    await updateDoc(raceRef, { 
                        [`players.${user.uid}.position`]: newPos,
                        lastUpdate: Date.now()
                    });
                }
            };

            const reset = () => setDoc(doc(db, RACE_DOC_PATH), { 
                raceStatus: 'LOBBY', 
                players: {}, 
                winnerId: null,
                lastUpdate: Date.now()
            });

            if (error) return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6 text-center bg-gray-950">
                    <div className="bg-red-900/10 border border-red-500/50 p-8 rounded-3xl max-w-sm">
                        <div className="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h2 className="text-xl font-bold text-red-400 mb-2">–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                        <p className="text-sm text-slate-400 mb-6">{error}</p>
                        <button onClick={() => window.location.reload()} className="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold transition-colors">–ü–ï–†–ï–ó–ê–ì–†–£–ó–ò–¢–¨</button>
                    </div>
                </div>
            );

            if (loading) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-950">
                    <div className="w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin mb-4"></div>
                    <div className="text-cyan-400 font-bold tracking-widest animate-pulse uppercase text-sm">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–≤—è–∑–∏...</div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto p-6 space-y-8 min-h-screen">
                    <header className="text-center pt-4">
                        <h1 className="text-4xl font-black tracking-tighter text-white italic italic">COSMIC RACE</h1>
                        <div className="flex justify-center gap-2 mt-2">
                            <span className="px-2 py-0.5 bg-slate-800 rounded text-[9px] text-slate-400 font-mono uppercase">ID: {appId}</span>
                            <span className="px-2 py-0.5 bg-slate-800 rounded text-[9px] text-emerald-500 font-mono uppercase">Online</span>
                        </div>
                    </header>

                    <main className="bg-slate-900/50 border border-slate-800 p-8 rounded-[2.5rem] shadow-2xl text-center space-y-6 backdrop-blur-sm">
                        {race?.raceStatus === 'LOBBY' && (
                            <div className="py-4 space-y-6">
                                <div className="space-y-1">
                                    <div className="text-yellow-500 text-[10px] font-black uppercase tracking-[0.2em]">–°—Ç–∞—Ç—É—Å: –û—á—ñ–∫—É–≤–∞–Ω–Ω—è</div>
                                    <p className="text-slate-400 text-sm">–ó–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å—Ç–∞—Ä—Ç—É</p>
                                </div>
                                {!race.players?.[user.uid] ? (
                                    <button onClick={join} className="btn-active w-full bg-cyan-600 hover:bg-cyan-500 py-5 rounded-2xl font-black text-white shadow-lg shadow-cyan-900/40 transition-all text-lg">–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–Ø</button>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="p-4 bg-cyan-500/10 border border-cyan-500/20 rounded-2xl text-cyan-400 text-sm font-bold">–í–∏ —É –≥—Ä—ñ! –û—á—ñ–∫—É–π—Ç–µ —ñ–Ω—à–∏—Ö...</div>
                                        <button onClick={start} className="btn-active w-full bg-emerald-600 hover:bg-emerald-500 py-5 rounded-2xl font-black text-white shadow-lg shadow-emerald-900/40 transition-all text-lg">–ü–û–ß–ê–¢–ò –ì–û–ù–ö–£</button>
                                    </div>
                                )}
                            </div>
                        )}

                        {race?.raceStatus === 'RACING' && (
                            <div className="py-4 space-y-8">
                                <div className="text-cyan-500 text-[10px] font-black uppercase tracking-[0.2em] animate-pulse">–ì–æ–Ω–∫–∞ —Ç—Ä–∏–≤–∞—î</div>
                                {race.players?.[user.uid] ? (
                                    <button onClick={move} className="btn-active w-40 h-40 mx-auto bg-gradient-to-br from-cyan-500 to-blue-700 rounded-full border-8 border-white/10 shadow-[0_0_50px_rgba(6,182,212,0.3)] flex items-center justify-center text-3xl font-black italic text-white transition-transform">PUSH!</button>
                                ) : (
                                    <div className="py-10 text-slate-500 italic text-sm">–í–∏ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á...</div>
                                )}
                            </div>
                        )}

                        {race?.raceStatus === 'FINISHED' && (
                            <div className="py-4 space-y-6">
                                <div className="text-white text-[10px] font-black uppercase tracking-[0.2em]">–§—ñ–Ω—ñ—à</div>
                                <div className="space-y-2">
                                    <div className="text-4xl">üèÜ</div>
                                    <h2 className="text-2xl font-black text-yellow-400 uppercase italic">–ü–µ—Ä–µ–º—ñ–≥ {race.players[race.winnerId]?.name}!</h2>
                                </div>
                                <button onClick={reset} className="btn-active w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl font-bold text-white transition-all">–ù–û–í–ê –ì–†–ê</button>
                            </div>
                        )}
                    </main>

                    <section className="space-y-4 pb-10">
                        <div className="flex justify-between items-center px-2">
                            <h3 className="text-[10px] text-slate-500 font-black uppercase tracking-widest">–¢–µ–ª–µ–º–µ—Ç—Ä—ñ—è –ø—ñ–ª–æ—Ç—ñ–≤</h3>
                            <span className="text-[10px] text-slate-600 font-mono">{Object.keys(race?.players || {}).length} –ü–Ü–õ–û–¢–Ü–í</span>
                        </div>
                        <div className="space-y-3">
                            {Object.entries(race?.players || {}).sort((a,b) => b[1].position - a[1].position).map(([id, p]) => (
                                <div key={id} className={`p-4 rounded-3xl border transition-all ${id === user.uid ? 'bg-cyan-950/20 border-cyan-500/50' : 'bg-slate-900/40 border-slate-800/50'}`}>
                                    <div className="flex items-center gap-4">
                                        <div className="text-2xl drop-shadow-md">{p.shipIcon}</div>
                                        <div className="flex-1">
                                            <div className="flex justify-between text-[11px] font-bold mb-2 uppercase tracking-tight">
                                                <span className={id === user.uid ? 'text-cyan-400' : 'text-slate-400'}>
                                                    {p.name} {id === user.uid && <span className="text-[9px] opacity-60 ml-1">(–í–ò)</span>}
                                                </span>
                                                <span className="font-mono">{Math.round(p.position)}%</span>
                                            </div>
                                            <div className="h-2 bg-slate-800 rounded-full overflow-hidden">
                                                <div className={`h-full progress-glow transition-all duration-300 ${id === user.uid ? 'bg-cyan-500' : 'bg-slate-600'}`} style={{width: `${p.position}%`}}></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {Object.keys(race?.players || {}).length === 0 && (
                                <div className="text-center py-10 border-2 border-dashed border-slate-800 rounded-[2rem] text-slate-600 text-xs uppercase tracking-widest font-bold">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω—å...</div>
                            )}
                        </div>
                    </section>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
